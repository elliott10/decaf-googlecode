#!/bin/bash
#
#
# Heng Yin <heyin@syr.edu>
#

target="i386-softmmu"
plugin_path=$(pwd)
echo plugin path is $plugin_path

decaf_path=""
lab_path=""
show_help="yes"

for opt do
  optarg=`expr "x$opt" : 'x[^=]*=\(.*\)'`
  case "$opt" in
  --help|-h) show_help="yes"
  ;;
  --decaf-path=*) decaf_path=`readlink -e "$optarg"`; show_help="no"
  ;;
  --lab-path=*) lab_path=`readlink -e "$optarg"`; show_help="no"
  ;;
  *) echo "ERROR: unknown option $opt"; show_help="yes"
  ;;
  esac
done

if test x"$show_help" = x"yes" ; then
cat << EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]

EOF
echo "Standard options:"
echo "  --help                  print this message"
echo "  --decaf-path=PATH       path to DECAF (must be specified)"
echo "  --lab-path=PATH       path to ucore lab (must be specified)"
echo ""
exit 1
fi

if [[ ! $decaf_path ]] ; then
  echo
  echo "ERROR: Path to DECAF does not exist. Please double check"
  exit
fi

if [[ ! $lab_path ]] ; then
  echo
  echo "ERROR: Path to ucore lab does not exist. Please double check"
  exit
fi

echo path to DECAF is $decaf_path
echo path to ucore lab is $lab_path

config_h="config-plugin.h"
config_mak="config-plugin.mak"
test -f $config_h && mv $config_h ${config_h}~
echo "# Automatically generated by configure - do not modify" > $config_mak

echo "TARGET_DIR=$target" >> $config_mak
echo "SRC_PATH=$decaf_path" >> $config_mak
echo "LAB_PATH=$lab_path" >> $config_mak
echo "PLUGIN_PATH=$plugin_path" >> $config_mak
echo "#define DEFINE_INSN_BEGIN" >> $config_h
echo "#define DEFINE_INSN_END" >> $config_h
echo "#define DEFINE_BLOCK_BEGIN" >> $config_h
echo "#define DEFINE_BLOCK_END" >> $config_h
echo "#define DECAF_HOME \"$decaf_path\"" >> $config_h
echo "#define PLUGIN_PATH \"$plugin_path\"" >> $config_h

func_log="$decaf_path/shared/kernelinfo/procinfo_generic/lib_conf/func_log.ini"
echo '[info]' > $func_log 
echo 'total = 1' >> $func_log
echo '' >> $func_log
echo '[1]' >> $func_log
echo '; ucore_lab' >> $func_log
echo 'decaf_conf_libpath = ucore_lab' >> $func_log
objdump -t $lab_path/obj/bootblock.o $lab_path/bin/kernel | awk '/\.text/ && $NF !~/\./ {printf("%-30s= %d\n",$NF,strtonum("0x"$1))}'|awk '!a[$1]++' >> $func_log

if [[ ! -e "$decaf_path/config-host.mak" ]]; then
 echo
 echo "WARNING: Looks like DECAF has not been configured yet."
 echo "          Please do that before making"
fi
